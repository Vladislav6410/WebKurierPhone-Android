name: üè™ Upload to Google Play (Service Account)

on:
  workflow_dispatch:
    inputs:
      track:
        description: "Play Store track"
        required: true
        default: "alpha"
        type: choice
        options:
          - alpha
          - beta
          - production
      status:
        description: "Release status"
        required: true
        default: "draft"
        type: choice
        options:
          - draft
          - inProgress
          - completed

concurrency:
  group: android-play-upload-${{ github.ref }}-${{ inputs.track }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  upload:
    name: Build AAB + Upload to Play
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      - name: üß∞ Set up Gradle 8.7
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: "8.7"

      - name: üîê Decode keystore (from secrets)
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -z "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "Missing secret ANDROID_KEYSTORE_BASE64"
            exit 1
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > app/release-keystore.jks

      - name: üèó Build signed Release AAB
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -z "$ANDROID_KEYSTORE_PASSWORD" ] || [ -z "$ANDROID_KEY_ALIAS" ] || [ -z "$ANDROID_KEY_PASSWORD" ]; then
            echo "Missing signing secrets (ANDROID_KEYSTORE_PASSWORD / ANDROID_KEY_ALIAS / ANDROID_KEY_PASSWORD)"
            exit 1
          fi

          # Create signing.properties for Gradle (keeps secrets out of repo)
          cat > signing.properties <<EOF
          storeFile=release-keystore.jks
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          keyPassword=$ANDROID_KEY_PASSWORD
          EOF

          # Build AAB
          gradle :app:bundleRelease -PsigningPropertiesFile=signing.properties

      - name: üì¶ Locate AAB
        id: aab
        run: |
          AAB_PATH=$(ls -1 app/build/outputs/bundle/release/*.aab | head -n 1)
          if [ -z "$AAB_PATH" ]; then
            echo "AAB not found"
            ls -R app/build/outputs/bundle || true
            exit 1
          fi
          echo "path=$AAB_PATH" >> $GITHUB_OUTPUT

      - name: üè™ Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.GOOGLE_PLAY_PACKAGE_NAME }}
          releaseFiles: ${{ steps.aab.outputs.path }}
          track: ${{ inputs.track }}
          status: ${{ inputs.status }}
          # Optional (enable later if needed):
          # inAppUpdatePriority: 2
          # userFraction: 0.1
          # whatsNewDirectory: distribution/whatsnew

      - name: üìé Upload AAB artifact (for traceability)
        uses: actions/upload-artifact@v4
        with:
          name: WebKurierPhone-Android-aab-uploaded-${{ inputs.track }}
          path: ${{ steps.aab.outputs.path }}
          if-no-files-found: error

      - name: üßπ Cleanup
        if: always()
        run: |
          rm -f app/release-keystore.jks signing.properties